!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).naja=e()}(this,(function(){"use strict";const t=t=>{"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()};class e extends Error{}const i=(t,i)=>{if(!t){throw new e("Assertion failed"+(void 0!==i?`: ${i}`:"."))}};class n extends EventTarget{constructor(t){super(),this.naja=t,this.selector=".ajax",this.allowedOrigins=[window.location.origin],this.handler=this.handleUI.bind(this),t.addEventListener("init",this.initialize.bind(this))}initialize(){t((()=>this.bindUI(window.document.body))),this.naja.snippetHandler.addEventListener("afterUpdate",(t=>{const{snippet:e}=t.detail;this.bindUI(e)}))}bindUI(t){const e=[`a${this.selector}`,`input[type="submit"]${this.selector}`,`input[type="image"]${this.selector}`,`button[type="submit"]${this.selector}`,`form${this.selector} input[type="submit"]`,`form${this.selector} input[type="image"]`,`form${this.selector} button[type="submit"]`].join(", "),i=t=>{t.removeEventListener("click",this.handler),t.addEventListener("click",this.handler)},n=t.querySelectorAll(e);for(let t=0;t<n.length;t++)i(n.item(t));t.matches(e)&&i(t);const s=t=>{t.removeEventListener("submit",this.handler),t.addEventListener("submit",this.handler)};t.matches(`form${this.selector}`)&&s(t);const a=t.querySelectorAll(`form${this.selector}`);for(let t=0;t<a.length;t++)s(a.item(t))}handleUI(t){const e=t;if(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey||e.button)return;const i=t.currentTarget,n=this.naja.prepareOptions(),s=()=>{};"submit"===t.type?this.submitForm(i,n,t).catch(s):"click"===t.type&&this.clickElement(i,n,e).catch(s)}async clickElement(t,e={},n){let s,a="GET",r="";if(!this.dispatchEvent(new CustomEvent("interaction",{cancelable:!0,detail:{element:t,originalEvent:n,options:e}})))return n?.preventDefault(),{};if("A"===t.tagName)i(t instanceof HTMLAnchorElement),a="GET",r=t.href,s=null;else if("INPUT"===t.tagName||"BUTTON"===t.tagName){i(t instanceof HTMLInputElement||t instanceof HTMLButtonElement);const{form:e}=t;if(a=t.getAttribute("formmethod")?.toUpperCase()??e?.getAttribute("method")?.toUpperCase()??"GET",r=t.getAttribute("formaction")??e?.getAttribute("action")??window.location.pathname+window.location.search,s=new FormData(e??void 0),"submit"===t.type&&""!==t.name)s.append(t.name,t.value||"");else if("image"===t.type){const e=t.getBoundingClientRect(),i=""!==t.name?`${t.name}.`:"";s.append(`${i}x`,Math.max(0,Math.floor(void 0!==n?n.pageX-e.left:0))),s.append(`${i}y`,Math.max(0,Math.floor(void 0!==n?n.pageY-e.top:0)))}}if(!this.isUrlAllowed(r))throw new Error(`Cannot dispatch async request, URL is not allowed: ${r}`);return n?.preventDefault(),this.naja.makeRequest(a,r,s,e)}async submitForm(t,e={},i){if(!this.dispatchEvent(new CustomEvent("interaction",{cancelable:!0,detail:{element:t,originalEvent:i,options:e}})))return i?.preventDefault(),{};const n=t.getAttribute("method")?.toUpperCase()??"GET",s=t.getAttribute("action")??window.location.pathname+window.location.search,a=new FormData(t);if(!this.isUrlAllowed(s))throw new Error(`Cannot dispatch async request, URL is not allowed: ${s}`);return i?.preventDefault(),this.naja.makeRequest(n,s,a,e)}isUrlAllowed(t){const e=new URL(t,location.href);return"null"!==e.origin&&this.allowedOrigins.includes(e.origin)}}class s{constructor(t){this.naja=t,t.addEventListener("init",this.initialize.bind(this)),t.uiHandler.addEventListener("interaction",this.processForm.bind(this))}initialize(){t((()=>this.initForms(window.document.body))),this.naja.snippetHandler.addEventListener("afterUpdate",(t=>{const{snippet:e}=t.detail;this.initForms(e)}))}initForms(t){const e=this.netteForms||window.Nette;if(e){"form"===t.tagName&&e.initForm(t);const i=t.querySelectorAll("form");for(let t=0;t<i.length;t++)e.initForm(i.item(t))}}processForm(t){const{element:e,originalEvent:i}=t.detail,n=e;void 0!==n.form&&null!==n.form&&(n.form["nette-submittedBy"]=e);const s=this.netteForms||window.Nette;"FORM"!==e.tagName&&!e.form||!s||s.validateForm(e)||(i&&(i.stopImmediatePropagation(),i.preventDefault()),t.preventDefault())}}class a extends EventTarget{constructor(t){super(),this.naja=t,t.uiHandler.addEventListener("interaction",(t=>{const{element:e,options:i}=t.detail;if(e&&(e.hasAttribute("data-naja-force-redirect")||e.form?.hasAttribute("data-naja-force-redirect"))){const t=e.getAttribute("data-naja-force-redirect")??e.form?.getAttribute("data-naja-force-redirect");i.forceRedirect="off"!==t}})),t.addEventListener("success",(t=>{const{payload:e,options:i}=t.detail;e.redirect&&(this.makeRedirect(e.redirect,i.forceRedirect??!1,i),t.stopImmediatePropagation())})),this.locationAdapter={assign:t=>window.location.assign(t)}}makeRedirect(t,e,i={}){t instanceof URL&&(t=t.href);let n=e||!this.naja.uiHandler.isUrlAllowed(t);this.dispatchEvent(new CustomEvent("redirect",{cancelable:!0,detail:{url:t,isHardRedirect:n,setHardRedirect(t){n=!!t},options:i}}))&&(n?this.locationAdapter.assign(t):this.naja.makeRequest("GET",t,null,i))}}class r extends EventTarget{constructor(t){super(),this.naja=t,this.op={replace:(t,e)=>{t.innerHTML=e},prepend:(t,e)=>t.insertAdjacentHTML("afterbegin",e),append:(t,e)=>t.insertAdjacentHTML("beforeend",e)},t.addEventListener("success",(t=>{const{options:e,payload:i}=t.detail;i.snippets&&this.updateSnippets(i.snippets,!1,e)}))}static findSnippets(t){const e={},i=window.document.querySelectorAll('[id^="snippet-"]');for(let n=0;n<i.length;n++){const s=i.item(n);(t?.(s)??1)&&(e[s.id]=s.innerHTML)}return e}updateSnippets(t,e=!1,i={}){Object.keys(t).forEach((n=>{const s=document.getElementById(n);s&&this.updateSnippet(s,t[n],e,i)}))}updateSnippet(t,e,i,n){let s=this.op.replace;!t.hasAttribute("data-naja-snippet-prepend")&&!t.hasAttribute("data-ajax-prepend")||i?!t.hasAttribute("data-naja-snippet-append")&&!t.hasAttribute("data-ajax-append")||i||(s=this.op.append):s=this.op.prepend;this.dispatchEvent(new CustomEvent("beforeUpdate",{cancelable:!0,detail:{snippet:t,content:e,fromCache:i,operation:s,changeOperation(t){s=t},options:n}}))&&("title"===t.tagName.toLowerCase()?document.title=e:s(t,e),this.dispatchEvent(new CustomEvent("afterUpdate",{cancelable:!0,detail:{snippet:t,content:e,fromCache:i,operation:s,options:n}})))}}class o extends EventTarget{constructor(t){super(),this.naja=t,this.initialized=!1,this.popStateHandler=this.handlePopState.bind(this),t.addEventListener("init",this.initialize.bind(this)),t.addEventListener("before",this.saveUrl.bind(this)),t.addEventListener("before",this.replaceInitialState.bind(this)),t.addEventListener("success",this.pushNewState.bind(this)),t.uiHandler.addEventListener("interaction",this.configureMode.bind(this)),this.historyAdapter={replaceState:(t,e,i)=>window.history.replaceState(t,e,i),pushState:(t,e,i)=>window.history.pushState(t,e,i)}}set uiCache(t){console.warn("Naja: HistoryHandler.uiCache is deprecated, use options.snippetCache instead."),this.naja.defaultOptions.snippetCache=t}handlePopState(t){const{state:e}=t;if("naja"!==e?.source)return;const i=this.naja.prepareOptions();this.dispatchEvent(new CustomEvent("restoreState",{detail:{state:e,options:i}}))}initialize(){window.addEventListener("popstate",this.popStateHandler)}saveUrl(t){const{url:e,options:i}=t.detail;i.href??=e}replaceInitialState(e){const{options:i}=e.detail;!1===o.normalizeMode(i.history)||this.initialized||(t((()=>this.historyAdapter.replaceState(this.buildState(window.location.href,i),window.document.title,window.location.href))),this.initialized=!0)}configureMode(t){const{element:e,options:i}=t.detail;if(e&&(e.hasAttribute("data-naja-history")||e.form?.hasAttribute("data-naja-history"))){const t=e.getAttribute("data-naja-history")??e.form?.getAttribute("data-naja-history");i.history=o.normalizeMode(t)}}static normalizeMode(t){return"off"!==t&&!1!==t&&("replace"!==t||"replace")}pushNewState(t){const{payload:e,options:i}=t.detail,n=o.normalizeMode(i.history);if(!1===n)return;e.postGet&&e.url&&(i.href=e.url);const s="replace"===n?"replaceState":"pushState";this.historyAdapter[s](this.buildState(i.href,i),window.document.title,i.href)}buildState(t,e){const i={source:"naja",href:t};return this.dispatchEvent(new CustomEvent("buildState",{detail:{state:i,options:e}})),i}}class d extends EventTarget{constructor(t){super(),this.naja=t,this.storages={off:new c(t),history:new l,session:new h},t.uiHandler.addEventListener("interaction",this.configureCache.bind(this)),t.historyHandler.addEventListener("buildState",this.buildHistoryState.bind(this)),t.historyHandler.addEventListener("restoreState",this.restoreHistoryState.bind(this))}resolveStorage(t){let e;return e=!0===t||void 0===t?"history":!1===t?"off":t,this.storages[e]}configureCache(t){const{element:e,options:i}=t.detail;if(e&&(e.hasAttribute("data-naja-snippet-cache")||e.form?.hasAttribute("data-naja-snippet-cache")||e.hasAttribute("data-naja-history-cache")||e.form?.hasAttribute("data-naja-history-cache"))){const t=e.getAttribute("data-naja-snippet-cache")??e.form?.getAttribute("data-naja-snippet-cache")??e.getAttribute("data-naja-history-cache")??e.form?.getAttribute("data-naja-history-cache");i.snippetCache=t}}buildHistoryState(t){const{state:e,options:i}=t.detail;"historyUiCache"in i&&(console.warn("Naja: options.historyUiCache is deprecated, use options.snippetCache instead."),i.snippetCache=i.historyUiCache);const n=r.findSnippets((t=>!(t.hasAttribute("data-naja-history-nocache")||t.hasAttribute("data-history-nocache")||t.hasAttribute("data-naja-snippet-cache")&&"off"===t.getAttribute("data-naja-snippet-cache"))));if(!this.dispatchEvent(new CustomEvent("store",{cancelable:!0,detail:{snippets:n,state:e,options:i}})))return;const s=this.resolveStorage(i.snippetCache);e.snippets={storage:s.type,key:s.store(n)}}restoreHistoryState(t){const{state:e,options:i}=t.detail;if(void 0===e.snippets)return;if(i.snippetCache=e.snippets.storage,!this.dispatchEvent(new CustomEvent("fetch",{cancelable:!0,detail:{state:e,options:i}})))return;const n=this.resolveStorage(i.snippetCache).fetch(e.snippets.key,e,i);null!==n&&this.dispatchEvent(new CustomEvent("restore",{cancelable:!0,detail:{snippets:n,state:e,options:i}}))&&(this.naja.snippetHandler.updateSnippets(n,!0,i),this.naja.scriptLoader.loadScripts(n))}}class c{constructor(t){this.naja=t,this.type="off"}store(){return null}fetch(t,e,i){return this.naja.makeRequest("GET",e.href,null,{...i,history:!1,snippetCache:!1}),null}}class l{constructor(){this.type="history"}store(t){return t}fetch(t){return t}}class h{constructor(){this.type="session"}store(t){const e=Math.random().toString(36).substring(2,8);return window.sessionStorage.setItem(e,JSON.stringify(t)),e}fetch(t){const e=window.sessionStorage.getItem(t);return null===e?null:JSON.parse(e)}}class p{constructor(e){this.loadedScripts=new Set,e.addEventListener("init",(()=>{t((()=>{document.querySelectorAll("script[data-naja-script-id]").forEach((t=>{const e=t.getAttribute("data-naja-script-id");null!==e&&""!==e&&this.loadedScripts.add(e)}))})),e.addEventListener("success",(t=>{const{payload:e}=t.detail;e.snippets&&this.loadScripts(e.snippets)}))}))}loadScripts(t){Object.keys(t).forEach((e=>{const i=t[e];if(!/<script/i.test(i))return;const n=window.document.createElement("div");n.innerHTML=i;const s=n.querySelectorAll("script");for(let t=0;t<s.length;t++){const e=s.item(t),i=e.getAttribute("data-naja-script-id");if(null!==i&&""!==i&&this.loadedScripts.has(i))continue;const n=window.document.createElement("script");if(n.innerHTML=e.innerHTML,e.hasAttributes()){const t=e.attributes;for(let e=0;e<t.length;e++){const i=t[e].name;n.setAttribute(i,t[e].value)}}window.document.head.appendChild(n).parentNode.removeChild(n),null!==i&&""!==i&&this.loadedScripts.add(i)}}))}}class u extends EventTarget{constructor(t,e,i,c,l,h,u){super(),this.VERSION=2,this.initialized=!1,this.extensions=[],this.defaultOptions={},this.uiHandler=new(t??n)(this),this.redirectHandler=new(e??a)(this),this.snippetHandler=new(i??r)(this),this.formsHandler=new(c??s)(this),this.historyHandler=new(l??o)(this),this.snippetCache=new(h??d)(this),this.scriptLoader=new(u??p)(this)}registerExtension(t){this.initialized&&t.initialize(this),this.extensions.push(t)}initialize(t={}){if(this.initialized)throw new Error("Cannot initialize Naja, it is already initialized.");this.defaultOptions=this.prepareOptions(t),this.extensions.forEach((t=>t.initialize(this))),this.dispatchEvent(new CustomEvent("init",{detail:{defaultOptions:this.defaultOptions}})),this.initialized=!0}prepareOptions(t){return{...this.defaultOptions,...t,fetch:{...this.defaultOptions.fetch,...t?.fetch}}}async makeRequest(t,e,i=null,n={}){"string"==typeof e&&(e=new URL(e,location.href)),n=this.prepareOptions(n);const s=new Headers(n.fetch.headers||{}),a=this.transformData(e,t,i),r=new AbortController,o=new Request(e.toString(),{credentials:"same-origin",...n.fetch,method:t,headers:s,body:a,signal:r.signal});if(o.headers.set("X-Requested-With","XMLHttpRequest"),o.headers.set("Accept","application/json"),!this.dispatchEvent(new CustomEvent("before",{cancelable:!0,detail:{request:o,method:t,url:e.toString(),data:i,options:n}})))return{};const d=window.fetch(o);let c,l;this.dispatchEvent(new CustomEvent("start",{detail:{request:o,promise:d,abortController:r,options:n}}));try{if(c=await d,!c.ok)throw new f(c);l=await c.json()}catch(t){if("AbortError"===t.name)return this.dispatchEvent(new CustomEvent("abort",{detail:{request:o,error:t,options:n}})),this.dispatchEvent(new CustomEvent("complete",{detail:{request:o,response:c,payload:void 0,error:t,options:n}})),{};throw this.dispatchEvent(new CustomEvent("error",{detail:{request:o,response:c,error:t,options:n}})),this.dispatchEvent(new CustomEvent("complete",{detail:{request:o,response:c,payload:void 0,error:t,options:n}})),t}return this.dispatchEvent(new CustomEvent("payload",{detail:{request:o,response:c,payload:l,options:n}})),this.dispatchEvent(new CustomEvent("success",{detail:{request:o,response:c,payload:l,options:n}})),this.dispatchEvent(new CustomEvent("complete",{detail:{request:o,response:c,payload:l,error:void 0,options:n}})),l}appendToQueryString(t,e,i){if(null!=i)if(Array.isArray(i)||Object.getPrototypeOf(i)===Object.prototype)for(const[n,s]of Object.entries(i))this.appendToQueryString(t,`${e}[${n}]`,s);else t.append(e,String(i))}transformData(t,e,i){const n=["GET","HEAD"].includes(e.toUpperCase());if(n&&i instanceof FormData){for(const[e,n]of i)null!=n&&t.searchParams.append(e,String(n));return null}if(null!==i&&Object.getPrototypeOf(i)===Object.prototype||Array.isArray(i)){const e=n?t.searchParams:new URLSearchParams;for(const[t,n]of Object.entries(i))this.appendToQueryString(e,t,n);return n?null:e}return i}}class f extends Error{constructor(t){const e=`HTTP ${t.status}: ${t.statusText}`;super(e),this.name=this.constructor.name,this.stack=new Error(e).stack,this.response=t}}const m=new u;return m.registerExtension(new class{constructor(){this.abortControllers=new Set}initialize(t){t.uiHandler.addEventListener("interaction",this.checkAbortable.bind(this)),t.addEventListener("init",this.onInitialize.bind(this)),t.addEventListener("start",this.saveAbortController.bind(this)),t.addEventListener("complete",this.removeAbortController.bind(this))}onInitialize(){document.addEventListener("keydown",(t=>{if("Escape"===t.key&&!(t.ctrlKey||t.shiftKey||t.altKey||t.metaKey)){for(const t of this.abortControllers)t.abort();this.abortControllers.clear()}}))}checkAbortable(t){const{element:e,options:i}=t.detail;(e.hasAttribute("data-naja-abort")||e.form?.hasAttribute("data-naja-abort"))&&(i.abort="off"!==(e.getAttribute("data-naja-abort")??e.form?.getAttribute("data-naja-abort")))}saveAbortController(t){const{abortController:e,options:i}=t.detail;!1!==i.abort&&(this.abortControllers.add(e),i.clearAbortExtension=()=>this.abortControllers.delete(e))}removeAbortController(t){const{options:e}=t.detail;!1!==e.abort&&e.clearAbortExtension&&e.clearAbortExtension()}}),m.registerExtension(new class{constructor(){this.abortControllers=new Map}initialize(t){t.uiHandler.addEventListener("interaction",this.checkUniqueness.bind(this)),t.addEventListener("start",this.abortPreviousRequest.bind(this)),t.addEventListener("complete",this.clearRequest.bind(this))}checkUniqueness(t){const{element:e,options:i}=t.detail,n=e.getAttribute("data-naja-unique")??e.form?.getAttribute("data-naja-unique");i.unique="off"!==n&&(n??"default")}abortPreviousRequest(t){const{abortController:e,options:i}=t.detail;!1!==i.unique&&(this.abortControllers.get(i.unique??"default")?.abort(),this.abortControllers.set(i.unique??"default",e))}clearRequest(t){const{request:e,options:i}=t.detail;e.signal.aborted||!1===i.unique||this.abortControllers.delete(i.unique??"default")}}),m.Naja=u,m.HttpError=f,m}));
//# sourceMappingURL=Naja.min.js.map
